<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorageAI - Intelligent Storage System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Tailwind Configuration for Purple Accent */
        :root {
            --primary-purple: #9933FF;
            --dark-bg: #1A1A2E;
            --card-bg: #22223A;
            --text-light: #E0E0E0;
        }
        .text-purple { color: var(--primary-purple); }
        .bg-card { background-color: var(--card-bg); }
        .border-purple-dashed { border: 2px dashed var(--primary-purple); }
        .shadow-purple { box-shadow: 0 0 15px rgba(153, 51, 255, 0.5); }
        
        /* Custom file input styling to match the purple theme */
        .file-input-theme::-webkit-file-upload-button {
            background-color: var(--primary-purple);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px; /* rounded-full */
            border: none;
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            margin-right: 1rem;
            transition: background-color 0.2s;
        }
        .file-input-theme:hover::-webkit-file-upload-button {
            background-color: #8000FF;
        }
    </style>
</head>

<body class="bg-[#1A1A2E] text-[#E0E0E0] p-6 min-h-screen">

    <!-- Header / Logo -->
    <header class="flex justify-between items-center mb-10">
        <div class="text-3xl font-bold flex items-center">
            <svg class="w-8 h-8 mr-3 text-purple" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zm0 9a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2z"></path></svg>
            <span class="text-white">Storage<span class="text-purple">AI</span></span>
        </div>
        <input type="text" placeholder="Search files..." class="bg-card p-2 rounded-lg border border-gray-600 focus:border-purple focus:ring-1 focus:ring-purple text-sm w-1/4">
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- 1. The Uploader Component -->
        <div class="lg:col-span-1 bg-card p-6 rounded-xl shadow-lg h-full">
            <div class="border-purple-dashed p-10 rounded-xl flex flex-col items-center justify-center text-center">
                <svg class="w-16 h-16 text-purple mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <h3 class="text-2xl font-semibold mb-2">Upload Your Files</h3>
                <p class="text-sm text-gray-400 mb-6">Drag and drop files here or click to browse. Supports all file types with intelligent categorization.</p>

                <form id="uploadForm" onsubmit="handleSubmission(event)" class="w-full space-y-4">
                    <input type="file" name="file" id="file_input" class="block w-full text-sm text-gray-500 file-input-theme cursor-pointer">
                    
                    <textarea name="json_data" rows="5" placeholder="OR paste your structured JSON data here." class="w-full p-3 bg-[#1A1A2E] border border-gray-600 rounded-lg text-sm focus:ring-purple focus:border-purple"></textarea>
                    
                    <input type="text" name="metadata_comment" placeholder="Optional Metadata Comment (e.g., 'Relational')" class="w-full p-3 bg-[#1A1A2E] border border-gray-600 rounded-lg text-sm focus:ring-purple focus:border-purple">
                    
                    <button type="submit" class="w-full bg-purple text-white py-3 rounded-lg font-bold hover:bg-[#8000FF] transition duration-200 shadow-purple">
                        Analyze and Store
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            
            <!-- Stats Cards Row (Real-Time Data) -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-card p-4 rounded-xl shadow-md flex flex-col items-start">
                    <div class="flex items-center text-purple mb-2">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zM5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm0 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        <span class="text-sm font-semibold">Storage Used</span>
                    </div>
                    <!-- TARGET FOR STORAGE USED -->
                    <p id="statStorage" class="text-2xl font-bold">-- / --</p>
                </div>
                <div class="bg-card p-4 rounded-xl shadow-md flex flex-col items-start">
                    <div class="flex items-center text-purple mb-2">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13 14L8 9l5-5V14zM4 18h12a1 1 0 000-2H4a1 1 0 000 2z"></path></svg>
                        <span class="text-sm font-semibold">Files Processed</span>
                    </div>
                     <!-- TARGET FOR FILE COUNT -->
                    <p id="statFiles" class="text-2xl font-bold">--</p>
                </div>
                <div class="bg-card p-4 rounded-xl shadow-md flex flex-col items-start">
                    <div class="flex items-center text-purple mb-2">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L10 9.586V6z" clip-rule="evenodd"></path></svg>
                        <span class="text-sm font-semibold">Last Upload</span>
                    </div>
                    <!-- TARGET FOR LAST UPLOAD TIME -->
                    <p id="statLastUpload" class="text-2xl font-bold">N/A</p>
                </div>
            </div>

            <!-- API Status Area -->
            <div class="bg-card p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-purple">API / Intelligence Status</h3>
                <pre id="result" class="bg-[#1A1A2E] p-4 rounded-lg overflow-x-auto text-sm text-green-300 whitespace-pre-wrap">Submit data to see the intelligent analysis and storage decision (SQL/NoSQL or Classification) here...</pre>
            </div>
            
            <!-- Recent Files Container -->
            <div class="bg-card p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-white">Recent Files <span class="text-sm float-right text-purple cursor-pointer hover:underline">View All</span></h3>
                <!-- TARGET FOR JAVASCRIPT: Dynamic content will be loaded here -->
                <div id="recentFilesContainer" class="grid grid-cols-2 gap-4">
                    <p class="col-span-2 text-center text-gray-500">Loading recent files...</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- Helper function to map file type to icon path ---
        function getIconPath(fileType) {
            // Document, Image, Video, Audio, Archive, Other
            switch(fileType) {
                case 'Document': return 'M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm6 10a1 1 0 100-2 1 1 0 000 2z';
                case 'Image': return 'M10 4a3 3 0 100 6 3 3 0 000-6zM3 17a1 1 0 01-1-1V4a1 1 0 011-1h14a1 1 0 011 1v12a1 1 0 01-1 1H3z';
                case 'Video': return 'M15 10l-4 4V6l4 4zM2 17a1 1 0 011-1h14a1 1 0 011 1H2z';
                case 'Audio': return 'M9 13H5a1 1 0 01-1-1V8a1 1 0 011-1h4l4-4v14l-4-4z';
                case 'Archive': return 'M5 16a2 2 0 01-2-2v-4a2 2 0 012-2h10a2 2 0 012 2v4a2 2 0 01-2 2H5zm0 2a2 2 0 002 2h6a2 2 0 002-2v-2a2 2 0 00-2-2H7a2 2 0 00-2 2v2z';
                default: return 'M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zm0 9a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2z'; // Database/Other icon
            }
        }

        // --- Function to generate the HTML for a single file card ---
        function createFileCardHTML(file) {
            const iconPath = getIconPath(file.type);
            
            // Simple display of 'category' as a proxy for 'time ago' in the MVP
            const timeAgo = file.category.replace(/_/g, ' '); // Clean up the category name
            
            return `
                <div class="bg-card p-4 rounded-xl flex items-center shadow-md border border-gray-700 hover:border-purple transition duration-150">
                    <div class="bg-purple/20 p-3 rounded-full mr-4">
                        <svg class="w-6 h-6 text-purple" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path></svg>
                    </div>
                    <div>
                        <p class="font-semibold">${file.name}</p>
                        <p class="text-xs text-gray-400">${file.size} â€¢ ${timeAgo}</p>
                    </div>
                </div>
            `;
        }
        
        // --- Function to fetch and update dashboard statistics (REAL-TIME) ---
        function loadDashboardStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('statStorage').textContent = `${data.storage_used} / ${data.storage_total}`;
                    document.getElementById('statFiles').textContent = data.files_processed.toLocaleString();
                    document.getElementById('statLastUpload').textContent = data.last_upload;
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                    // Handle API failure gracefully (e.g., set stats to Error or N/A)
                    document.getElementById('statStorage').textContent = `API Error`;
                    document.getElementById('statFiles').textContent = `API Error`;
                    document.getElementById('statLastUpload').textContent = `API Error`;
                });
        }

        // --- Function to fetch and render the files ---
        function loadRecentFiles() {
            const container = document.getElementById('recentFilesContainer');
            container.innerHTML = '<p class="col-span-2 text-center text-gray-500">Loading...</p>';

            fetch('/api/recent_files')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.recent_files && data.recent_files.length > 0) {
                        container.innerHTML = ''; // Clear the "Loading..." message
                        data.recent_files.forEach(file => {
                            container.innerHTML += createFileCardHTML(file);
                        });
                    } else if (data.error) {
                         container.innerHTML = `<p class="col-span-2 text-center text-red-500">Error loading files: ${data.error}</p>`;
                    }
                    else {
                        container.innerHTML = '<p class="col-span-2 text-center text-gray-500">No files found in storage yet. Try uploading one!</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = '<p class="col-span-2 text-center text-red-500">Failed to communicate with file API.</p>';
                    console.error('Error fetching recent files:', error);
                });
        }
        
        // --- Main submission handler (Updated to call loadRecentFiles and loadDashboardStats) ---
        function handleSubmission(event) {
            event.preventDefault(); 
            
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            const resultArea = document.getElementById('result');
            resultArea.textContent = 'Analyzing and Storing...';
            resultArea.classList.remove('text-green-300', 'text-red-500'); 
            resultArea.classList.add('text-yellow-400'); 

            fetch('/api/store', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                // Display the beautiful JSON result
                resultArea.textContent = JSON.stringify(data, null, 4); 
                resultArea.classList.remove('text-yellow-400');
                
                if (data.status === 'error') {
                     resultArea.classList.add('text-red-500'); // Error color
                } else {
                     resultArea.classList.add('text-green-300'); // Success color
                }
                
                // CRUCIAL: Refresh both the file list and the stats immediately
                loadRecentFiles(); 
                loadDashboardStats();
            })
            .catch(error => {
                resultArea.textContent = 'An error occurred. Check the browser console and Flask terminal.';
                resultArea.classList.remove('text-yellow-400');
                resultArea.classList.add('text-red-500'); // Error color
                console.error('Fetch Error:', error);
            });
        }

        // --- Initial Page Load and Real-Time Interval Setup ---
        window.onload = function() {
            // Initial load for both elements
            loadRecentFiles();
            loadDashboardStats(); 
            
            // Set up interval for real-time stats update (every 5 seconds)
            setInterval(loadDashboardStats, 5000);
        };
    </script>
</body>
</html>