<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorageAI - Intelligent Storage System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom Tailwind Configuration for Purple Accent */
        :root {
            --primary-purple: #9933FF;
            --dark-bg: #1A1A2E;
            --card-bg: #22223A;
            --text-light: #E0E0E0;
        }
        .text-purple { color: var(--primary-purple); }
        .bg-card { background-color: var(--card-bg); }
        .border-purple-dashed { border: 2px dashed var(--primary-purple); }
        .shadow-purple { box-shadow: 0 0 15px rgba(153, 51, 255, 0.5); }
        
        /* Custom file input styling to match the purple theme */
        .file-input-theme::-webkit-file-upload-button {
            background-color: var(--primary-purple);
            color: white;
            padding: 8px 16px;
            border-radius: 9999px; 
            border: none;
            cursor: pointer;
            font-size: 0.875rem; 
            font-weight: 600; 
            margin-right: 1rem;
            transition: background-color 0.2s;
        }
        .file-input-theme:hover::-webkit-file-upload-button {
            background-color: #8000FF;
        }

        /* Modal specific styling */
        .modal-fade-enter { opacity: 0; transform: scale(0.95); }
        .modal-fade-enter-active { 
            opacity: 1; 
            transform: scale(1); 
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; 
        }
        .g_id_signin { display: flex; justify-content: center; } 
    </style>
</head>

<body class="bg-[#1A1A2E] text-[#E0E0E0] p-6 min-h-screen">

    <header class="flex justify-between items-center mb-10">
        <div class="text-3xl font-bold flex items-center">
            <svg class="w-8 h-8 mr-3 text-purple" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zm0 9a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2z"></path></svg>
            <span class="text-white">Storage<span class="text-purple">AI</span></span>
        </div>
        
        <div id="authContainer" class="flex items-center space-x-4">
            <div class="relative flex items-center">
                <input type="text" id="search_input" placeholder="Search files..." 
                        class="bg-card p-2 pl-4 rounded-full border border-gray-600 focus:border-purple focus:ring-1 focus:ring-purple text-sm w-48 transition-all duration-300 pr-10"
                        onkeydown="if(event.key === 'Enter') handleSearch()">
                
                <button onclick="startVoiceSearch()" 
                        class="absolute right-0 top-0 h-full w-10 text-gray-400 hover:text-purple transition duration-150 rounded-r-full flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 4a3 3 0 00-3 3v2a3 3 0 003 3h2a3 3 0 003-3V7a3 3 0 00-3-3H7zm4 10.882A6 6 0 007 14a6 6 0 00-4 4.882V20h14v-1.118zM14 7h1a3 3 0 013 3v2a3 3 0 01-3 3h-1v-2h2a1 1 0 001-1V7h-1zm-3-3H7a3 3 0 00-3 3v2a3 3 0 003 3h2a3 3 0 003-3V7a3 3 0 00-3-3z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
        </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1 bg-card p-6 rounded-xl shadow-lg h-full">
            <div class="border-purple-dashed p-10 rounded-xl flex flex-col items-center justify-center text-center">
                <svg class="w-16 h-16 text-purple mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <h3 class="text-2xl font-semibold mb-2">Upload Your Files</h3>
                <p class="text-sm text-gray-400 mb-6">Drag and drop files here or click to browse. Supports all file types with intelligent categorization.</p>

                <form id="uploadForm" onsubmit="handleSubmission(event)" class="w-full space-y-4">
                    <input type="file" name="file" id="file_input" 
                        class="block w-full text-sm text-gray-500 file-input-theme cursor-pointer">

                    <textarea name="json_data" rows="5" 
                        placeholder="OR paste your structured JSON data here." 
                        class="w-full p-3 bg-[#1A1A2E] border border-gray-600 rounded-lg text-sm 
                                focus:ring-purple focus:border-purple">
                    </textarea>

                    <input type="text" name="metadata_comment" 
                        placeholder="Optional Metadata Comment (e.g., 'Relational')" 
                        class="w-full p-3 bg-[#1A1A2E] border border-gray-600 rounded-lg text-sm 
                                focus:ring-purple focus:border-purple">

                    <div class="flex items-center justify-center space-x-2 text-sm text-gray-400 mt-3">
                        <input type="checkbox" name="auto_compress" id="auto_compress" 
                                class="form-checkbox h-5 w-5 rounded bg-card text-purple 
                                        border-gray-600 focus:ring-purple">
                        <label for="auto_compress" class="cursor-pointer">
                            Auto-compress to save space?
                        </label>
                    </div>

                    <button type="submit"
                            class="w-full bg-purple text-white py-3 rounded-lg font-bold 
                                hover:bg-[#8A2BE2] transition duration-200 shadow-purple mt-4">
                        Analyze and Store
                    </button>
                </form>
                
                <div class="mt-6 w-full flex justify-between space-x-2">
                    <button onclick="openCamera(false)"
                            class="flex-1 bg-gray-600/50 text-white py-2 rounded-lg text-sm hover:bg-gray-600 transition">
                        <span class="text-lg">üì∑</span> Photo Capture
                    </button>
                    <button onclick="openCamera(true)"
                            class="flex-1 bg-gray-600/50 text-white py-2 rounded-lg text-sm hover:bg-gray-600 transition">
                        <span class="text-lg">üìÑ</span> Document OCR
                    </button>
                </div>

            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-card p-4 rounded-xl shadow-md flex flex-col items-start">
                    <div class="flex items-center text-purple mb-2">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zM5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm0 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        <span class="text-sm font-semibold">Storage Used</span>
                    </div>
                    <p id="statStorage" class="text-2xl font-bold">-- / --</p>
                </div>
                <div class="bg-card p-4 rounded-xl shadow-md flex flex-col items-start">
                    <div class="flex items-center text-purple mb-2">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13 14L8 9l5-5V14zM4 18h12a1 1 0 000-2H4a1 1 0 000 2z"></path></svg>
                        <span class="text-sm font-semibold">Files Processed</span>
                    </div>
                        <p id="statFiles" class="text-2xl font-bold">--</p>
                </div>
                <div class="bg-card p-4 rounded-xl shadow-md flex flex-col items-start">
                    <div class="flex items-center text-purple mb-2">
                        <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L10 9.586V6z" clip-rule="evenodd"></path></svg>
                        <span class="text-sm font-semibold">Last Upload</span>
                    </div>
                    <p id="statLastUpload" class="text-2xl font-bold">N/A</p>
                </div>
            </div>

            <div class="bg-card p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-purple">API / Intelligence Status</h3>
                <pre id="result" class="bg-[#1A1A2E] p-4 rounded-lg overflow-x-auto text-sm text-green-300 whitespace-pre-wrap">Submit data to see the intelligent analysis and storage decision (SQL/NoSQL or Classification) here...</pre>
            </div>
            
            <div class="bg-card p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-white">Recent Files <span class="text-sm float-right text-purple cursor-pointer hover:underline">View All</span></h3>
                <div id="recentFilesContainer" class="grid grid-cols-2 gap-4">
                    <p class="col-span-2 text-center text-gray-500">Loading recent files...</p>
                </div>
            </div>

        </div>
    </main>

    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex flex-col items-center justify-center">
        <div class="p-6 rounded-xl bg-card shadow-lg w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="cameraTitle" class="text-2xl font-semibold mb-4 text-purple">Direct Capture</h2>
            
            <video id="videoStream" class="w-full h-auto bg-black rounded-lg mb-4" autoplay></video>
            <canvas id="captureCanvas" class="hidden"></canvas>
            <div id="captureArea" class="hidden flex flex-col items-center justify-center">
                    <img id="capturedImage" class="w-full h-auto rounded-lg mb-4 hidden border-2 border-purple" />
                    <p class="text-sm text-gray-400 mb-2">Image captured. Click Send to store.</p>
            </div>
            
            <div class="flex justify-between">
                <button id="captureButton" onclick="takePhoto()" class="bg-purple text-white py-2 px-6 rounded-lg font-bold hover:bg-[#8000FF] transition duration-200">
                    <span class="text-lg">üì∏</span> Capture
                </button>
                <button id="sendButton" onclick="sendCapturedData()" class="bg-green-500 text-white py-2 px-6 rounded-lg font-bold hover:bg-green-600 transition duration-200 hidden">
                    <span class="text-sm">‚¨ÜÔ∏è</span> Send to StorageAI
                </button>
                <button onclick="closeCamera()" class="bg-gray-700 text-white py-2 px-6 rounded-lg font-bold hover:bg-gray-600 transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <div id="fileViewerModal" class="fixed inset-0 z-50 bg-black bg-opacity-80 backdrop-blur-sm hidden p-6">
        <div class="bg-dark-bg w-full max-w-5xl mx-auto h-full rounded-xl shadow-purple overflow-hidden flex flex-col">
            <div class="p-4 bg-card flex justify-between items-center border-b border-gray-700">
                <h2 id="modalTitle" class="text-xl font-bold text-purple">File Viewer</h2>
                <button onclick="closeFileViewer()" class="text-white hover:text-red-500 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modalContent" class="flex-grow p-4 overflow-auto text-sm text-gray-300 flex items-center justify-center">
                Loading file content...
            </div>
        </div>
    </div>

    <script>
        // --- AUTHENTICATION JS FUNCTIONS (Simplified for Demo) ---
        
        // Simplified Header Management: ONLY handles the appearance (no auth logic)
        function updateHeader(username = null) {
             // Since the search bar HTML is hardcoded in the body, this function only needs to be called
             // to ensure the DOMContentLoaded setup is clean. We do not need complex logic here anymore.
        }

        // --- CAMERA & CAPTURE LOGIC (Unchanged) ---
        let stream = null;
        let isOCRAttempt = false;

        function openCamera(isOcr) {
            isOCRAttempt = isOcr;
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('videoStream');
            const captureArea = document.getElementById('captureArea');
            const capturedImage = document.getElementById('capturedImage');
            const captureButton = document.getElementById('captureButton');
            const sendButton = document.getElementById('sendButton');
            const title = document.getElementById('cameraTitle');

            // Reset view
            video.style.display = 'block';
            captureArea.style.display = 'none';
            capturedImage.style.display = 'none';
            sendButton.classList.add('hidden');
            captureButton.style.display = 'block';

            title.textContent = isOcr ? "Document OCR Scan" : "Direct Media Capture (Photo/Video)";

            navigator.mediaDevices.getUserMedia({ video: true, audio: isOcr ? false : true })
                .then(s => {
                    stream = s;
                    video.srcObject = stream;
                    modal.classList.remove('hidden');
                })
                .catch(err => {
                    alert("Error accessing camera. Please ensure your camera is connected and allowed.");
                    console.error("Camera access error:", err);
                    modal.classList.add('hidden');
                });
        }

        function closeCamera() {
            const modal = document.getElementById('cameraModal');
            modal.classList.add('hidden');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            stream = null;
        }

        function takePhoto() {
            const video = document.getElementById('videoStream');
            const canvas = document.getElementById('captureCanvas');
            const capturedImage = document.getElementById('capturedImage');
            const sendButton = document.getElementById('sendButton');
            const captureButton = document.getElementById('captureButton');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataURL = canvas.toDataURL('image/jpeg', 0.9); 

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.style.display = 'none';
            
            capturedImage.src = dataURL;
            capturedImage.style.display = 'block';
            sendButton.classList.remove('hidden');
            captureButton.style.display = 'none';
        }

        function sendCapturedData() {
            const canvas = document.getElementById('captureCanvas');
            
            canvas.toBlob(blob => {
                const formData = new FormData();
                
                const fileName = isOCRAttempt ? 'ocr_scan.jpg' : 'captured_media.jpg';
                formData.append('file', blob, fileName);

                formData.append('metadata_comment', isOCRAttempt ? 'ocr_scan_request' : 'direct_capture');
                
                const resultArea = document.getElementById('result');
                resultArea.textContent = `Analyzing and Storing captured data (${isOCRAttempt ? 'OCR' : 'Media'})...`;
                resultArea.classList.remove('text-green-300', 'text-red-500'); 
                resultArea.classList.add('text-yellow-400'); 
                
                fetch('/api/store', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    resultArea.textContent = JSON.stringify(data, null, 4); 
                    resultArea.classList.remove('text-yellow-400');
                    data.status === 'error' ? resultArea.classList.add('text-red-500') : resultArea.classList.add('text-green-300');
                    
                    loadRecentFiles(); 
                    loadDashboardStats();
                    closeCamera();
                })
                .catch(error => {
                    resultArea.textContent = 'An error occurred during capture submission.';
                    resultArea.classList.remove('text-yellow-400');
                    resultArea.classList.add('text-red-500'); 
                    console.error('Fetch Error:', error);
                });
                
            }, 'image/jpeg');
        }


        // --- FILE VIEWER FUNCTIONS (CORRECTED) ---

        // Function to close the file viewer modal (Unchanged)
        function closeFileViewer() {
            document.getElementById('fileViewerModal').classList.add('hidden');
            document.getElementById('modalContent').innerHTML = 'Loading file content...';
        }

        // Function to open the file viewer modal and fetch content (FINAL FIX)
        function openFileViewer(pathInfo, filename, fileType) {
            const modal = document.getElementById('fileViewerModal');
            const title = document.getElementById('modalTitle');
            const contentArea = document.getElementById('modalContent');
            
            title.textContent = `Viewing: ${filename}`;
            contentArea.innerHTML = '<p class="text-center py-10 text-yellow-400">Fetching and preparing file...</p>';
            contentArea.classList.add('items-center', 'justify-center');
            modal.classList.remove('hidden');

            // FIX: Encode pathInfo to handle special characters (e.g., spaces and slashes)
            const encodedPathInfo = encodeURIComponent(pathInfo);
            const viewApiUrl = `/api/view_file/${encodedPathInfo}`;

            // Determine the true file extension, stripping .gz if present
            const isCompressed = filename.toLowerCase().endsWith('.gz');
            const trueFilename = isCompressed ? filename.slice(0, -3) : filename;
            const trueExt = trueFilename.split('.').pop().toLowerCase();
            
            // Helper to check for common image/video extensions
            const isImage = ['png', 'jpg', 'jpeg', 'webp', 'gif'].includes(trueExt);
            const isVideo = ['mp4', 'mov', 'webm'].includes(trueExt);
            const isPdf = (trueExt === 'pdf');


            // --- 1. Handle Images ---
            if (isImage) {
                contentArea.classList.remove('items-center', 'justify-center');
                // The browser will handle decompression/MIME type based on the backend's response headers.
                contentArea.innerHTML = `<img src="${viewApiUrl}" alt="${filename}" class="max-h-full max-w-full object-contain mx-auto">`;
                return;
            } 
            
            // --- 2. Handle PDFs ---
            if (isPdf) {
                contentArea.classList.remove('items-center', 'justify-center');
                // Use iframe for native PDF rendering
                contentArea.innerHTML = `<iframe src="${viewApiUrl}" class="w-full h-full" style="min-height: 500px;" frameborder="0"></iframe>`;
                return;
            } 

            // --- 2.5 Handle Videos ---
            if (isVideo) {
                contentArea.classList.remove('items-center', 'justify-center');
                // The browser handles playback based on the backend's response headers.
                contentArea.innerHTML = `<video controls class="w-full h-auto max-w-full" src="${viewApiUrl}">
                                            Your browser does not support the video tag.
                                        </video>`;
                return;
            }
            
            // --- 3. Handle Text-Based Content (JSON, TXT, GZ, etc.) ---
            // Fetch the content and display as pre-formatted text.
            if (fileType === 'JSON' || fileType === 'Document' || fileType === 'Other' || fileType === 'Archive' || isCompressed) {
                fetch(viewApiUrl)
                    .then(response => {
                        // Crucial: Server needs to handle decompression and return plain text (or JSON text)
                        if (!response.ok) throw new Error(`Server returned status: ${response.status}`);
                        // Important: Since the file type is non-image/video/pdf, read as text
                        return response.text(); 
                    })
                    .then(text => {
                        contentArea.classList.remove('items-center', 'justify-center');
                        let formattedText = text;
                        let textColor = 'text-gray-300';
                        
                        if (trueExt === 'json') {
                            try {
                                const parsed = JSON.parse(text);
                                formattedText = JSON.stringify(parsed, null, 2);
                                textColor = 'text-green-300';
                            } catch (e) {
                                // Keep raw text if JSON parsing fails
                            }
                        }

                        contentArea.innerHTML = `<pre class="whitespace-pre-wrap p-4 bg-gray-800 rounded-lg ${textColor}">${formattedText}</pre>`;
                    })
                    .catch(error => {
                        contentArea.innerHTML = `<p class="text-center py-10 text-red-500">Error viewing file: ${error.message}. It might be a non-text file or an unsupported format (Status 404 implies file not found or path error).</p>`;
                        console.error("View File Error:", error);
                    });
                return;
            }

            // --- 4. Fallback for Unsupported Media Types ---
            contentArea.classList.add('items-center', 'justify-center'); 
            contentArea.innerHTML = `<p class="text-center py-10 text-red-500">
                File type **${fileType}** is not supported for inline viewing yet. 
                <br>Please download the file directly from the storage folder.
            </p>`;
        }
        
        // --- DASHBOARD AND UTILITY FUNCTIONS ---
        function getIconPath(fileType) {
            switch(fileType) {
                case 'Document': return 'M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm6 10a1 1 0 100-2 1 1 0 000 2z';
                case 'Image': return 'M10 4a3 3 0 100 6 3 3 0 000-6zM3 17a1 1 0 01-1-1V4a1 1 0 011-3h14a1 1 0 011 1v12a1 1 0 01-1 1H3z';
                case 'Video': return 'M15 10l-4 4V6l4 4zM2 17a1 1 0 011-1h14a1 1 0 011 1H2z';
                case 'Audio': return 'M9 13H5a1 1 0 01-1-1V8a1 1 0 011-1h4l4-4v14l-4-4z';
                case 'Archive': return 'M5 16a2 2 0 01-2-2v-4a2 2 0 012-2h10a2 2 0 012 2v4a2 2 0 01-2 2H5zm0 2a2 2 0 002 2h6a2 2 0 002-2v-2a2 2 0 00-2-2H7a2 2 0 00-2 2v2z';
                case 'JSON': return 'M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zm0 9a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2z'; 
                default: return 'M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zm0 9a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2a2 2 0 00-2 2v2z';
            }
        }
        
        // --- START CORRECTION for Compressed File Display ---
        function createFileCardHTML(file) {
            const iconPath = getIconPath(file.type);
            const timeAgo = file.category.replace(/_/g, ' '); 
            
            // FIX: Display name without .gz if it exists, for cleaner UI
            let displayName = file.name;
            if (displayName.toLowerCase().endsWith('.gz')) {
                displayName = displayName.slice(0, -3);
                // Optionally add a visual indicator for compressed files
                displayName = `üì¶ ${displayName}`;
            }

            return `
                <div class="bg-card p-4 rounded-xl flex items-center shadow-md border border-gray-700 hover:border-purple transition duration-150 cursor-pointer" 
                    onclick="openFileViewer('${file.server_path_info}', '${file.name}', '${file.type}')">
                    <div class="bg-purple/20 p-3 rounded-full mr-4">
                        <svg class="w-6 h-6 text-purple" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path></svg>
                    </div>
                    <div>
                        <p class="font-semibold">${displayName}</p>
                        <p class="text-xs text-gray-400">${file.size} ‚Ä¢ ${timeAgo}</p>
                    </div>
                </div>
            `;
        }
        // --- END CORRECTION for Compressed File Display ---

        function loadDashboardStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('statStorage').textContent = `${data.storage_used} / ${data.storage_total}`;
                    document.getElementById('statFiles').textContent = data.files_processed.toLocaleString();
                    document.getElementById('statLastUpload').textContent = data.last_upload;
                })
                .catch(error => {
                    console.error('Error fetching stats:', error);
                    document.getElementById('statStorage').textContent = `API Error`;
                    document.getElementById('statFiles').textContent = `API Error`;
                    document.getElementById('statLastUpload').textContent = `API Error`;
                });
        }

        function loadRecentFiles() {
            const container = document.getElementById('recentFilesContainer');
            container.innerHTML = '<p class="col-span-2 text-center text-gray-500">Loading...</p>';

            fetch('/api/recent_files')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.recent_files && data.recent_files.length > 0) {
                        container.innerHTML = ''; 
                        data.recent_files.forEach(file => {
                            container.innerHTML += createFileCardHTML(file);
                        });
                    } else if (data.error) {
                            container.innerHTML = `<p class="col-span-2 text-center text-red-500">Error loading files: ${data.error}</p>`;
                    }
                    else {
                        container.innerHTML = '<p class="col-span-2 text-center text-gray-500">No files found in storage yet. Try uploading one!</p>';
                    }
                })
                .catch(error => {
                    container.innerHTML = '<p class="col-span-2 text-center text-red-500">Failed to communicate with file API.</p>';
                    console.error('Error fetching recent files:', error);
                });
        }
        
        function handleSubmission(event) {
            event.preventDefault(); 
            
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            const resultArea = document.getElementById('result');
            resultArea.textContent = 'Analyzing and Storing...';
            resultArea.classList.remove('text-green-300', 'text-red-500'); 
            resultArea.classList.add('text-yellow-400'); 

            fetch('/api/store', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                resultArea.textContent = JSON.stringify(data, null, 4); 
                resultArea.classList.remove('text-yellow-400');
                
                if (data.status === 'error') {
                        resultArea.classList.add('text-red-500'); 
                } else {
                        resultArea.classList.add('text-green-300'); 
                }
                
                loadRecentFiles(); 
                loadDashboardStats();
            })
            .catch(error => {
                resultArea.textContent = 'An error occurred. Check the browser console and Flask terminal.';
                resultArea.classList.remove('text-yellow-400');
                resultArea.classList.add('text-red-500'); 
                console.error('Fetch Error:', error);
            });
        }


        // ADDED: SEARCH & VOICE SEARCH FUNCTIONS
        // -------------------------------------
        function updateSearchPlaceholder(text) {
            const input = document.getElementById('search_input');
            input.placeholder = text;
            setTimeout(() => { 
                input.placeholder = 'Search files...';
                if (input.value === '') input.focus();
            }, 3000);
        }

        async function handleSearch() {
            const query = document.getElementById('search_input').value.trim();
            if (query === '') {
                updateSearchPlaceholder("Please enter a query or use voice search.");
                loadRecentFiles(); // Reload default list if search is empty
                return;
            }

            // Show loading state
            const container = document.getElementById('recentFilesContainer');
            container.innerHTML = `<p class="col-span-2 text-center text-yellow-400">Searching for files matching: **${query}**...</p>`;

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<p class="col-span-2 text-center text-red-500">Search Error: ${data.error}</p>`;
                    return;
                }

                if (data.results && data.results.length > 0) {
                    container.innerHTML = ''; 
                    data.results.forEach(file => {
                        // Re-use the existing file card creation function
                        container.innerHTML += createFileCardHTML(file);
                    });
                } else {
                    container.innerHTML = `<p class="col-span-2 text-center text-gray-500">No files found matching **${query}**.</p>`;
                }

            } catch (error) {
                container.innerHTML = '<p class="col-span-2 text-center text-red-500">Network failed during search API call.</p>';
                console.error('Search Fetch Error:', error);
            }
        }
        
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Voice search is not supported in this browser. Please use Chrome or a modern, compatible browser.");
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false; // Only capture a single phrase
            recognition.lang = 'en-US'; 
            recognition.interimResults = false; 
            recognition.maxAlternatives = 1;

            const searchInput = document.getElementById('search_input');
            searchInput.value = ''; // Clear input before listening
            updateSearchPlaceholder("üëÇ Listening... Speak your query now.");
            
            // On recognition result
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                searchInput.value = transcript;
                updateSearchPlaceholder("üó£Ô∏è Recognized. Searching...");
                handleSearch(); // Execute search with the voice result
            };

            // On recognition start
            recognition.onstart = () => {
                // Change the microphone icon temporarily if desired (e.g., to a pulsating circle)
                // For simplicity, we rely on the placeholder update.
            };

            // On recognition end (Success or Failure)
            recognition.onend = () => {
                if (searchInput.value === '') {
                    updateSearchPlaceholder("No speech recognized. Try again.");
                }
            };
            
            // On error
            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                updateSearchPlaceholder(`Voice error: ${event.error}`);
            };

            recognition.start();
        }

        // --- End Search Functions ---

        // --- Final Initialization ---
        document.addEventListener('DOMContentLoaded', (event) => {
            // 1. Load initial dashboard data (Simplified to direct load)
            updateHeader(); // Renders the search bar
            loadRecentFiles(); 
            loadDashboardStats(); 
            
            // 2. Set up interval for stats update
            setInterval(loadDashboardStats, 5000);
        });
    </script>
</body>
</html>